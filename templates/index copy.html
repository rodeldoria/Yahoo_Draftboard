<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yahoo Fantasy Sports Draft Board</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      .banner {
        background-color: #4caf50;
        color: white;
        padding: 10px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
      }

      .intro {
        margin: 20px;
        font-size: 16px;
      }

      .compact-input,
      .compact-button {
        margin: 10px 0;
      }

      .compact-input {
        padding: 5px;
        font-size: 14px;
        border: 1px solid #444;
        border-radius: 5px;
        background-color: #333;
        color: #fff;
      }

      .compact-button {
        padding: 5px 10px;
        font-size: 14px;
        border: 1px solid #444;
        border-radius: 5px;
        background-color: #4caf50;
        color: white;
        cursor: pointer;
      }

      .compact-button:hover {
        background-color: #555;
      }

      .round-container,
      .teams-container,
      .player-details-container {
        margin-bottom: 20px;
      }

      .round-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .player-cards {
        display: flex;
        gap: 5px;
        flex-wrap: nowrap;
        /* Ensure all cards are on one row */
        overflow-x: auto;
        /* Allow horizontal scrolling if needed */
      }

      .player-card {
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 5px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        font-size: 10px;
        height: 100px;
        width: 80px;
        /* Adjust width to fit more cards in one row */
        position: relative;
        background-color: #f0f0f0;
        /* Default background color */
      }

      .player-card img {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
      }

      .player-info {
        margin-top: 5px;
        font-size: 10px;
      }

      .player-name {
        font-weight: bold;
        margin-top: auto;
        /* Pushes the name to the bottom */
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        width: 100%;
        font-size: 10px;
        font-weight: bold;
      }

      .dark-theme {
        background-color: #333;
        color: #fff;
      }

      .light-theme {
        background-color: #fff;
        color: #000;
      }

      /* Position-specific colors */
      .QB {
        background-color: #ffe4b5;
        /* Moccasin */
      }

      .RB {
        background-color: #98fb98;
        /* PaleGreen */
      }

      .WR {
        background-color: #b0e0e6;
        /* PowderBlue */
      }

      .TE {
        background-color: #ffb6c1;
        /* LightPink */
      }

      .K {
        background-color: #ffdab9;
        /* PeachPuff */
      }

      .DEF {
        background-color: #dda0dd;
        /* Plum */
      }

      /* New styles for the draft results table */
      .draft-results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .draft-results-table th,
      .draft-results-table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }

      .draft-results-table th {
        background-color: #4caf50;
        color: white;
      }

      .draft-results-table tr:nth-child(even) {
        background-color: #f2f2f2;
      }
    </style>
  </head>

  <body class="light-theme">
    <div class="banner">Yahoo Fantasy Sports Draft Board</div>
    <div class="intro">
      Welcome to the Yahoo Fantasy Sports Draft Board! This tool helps you
      manage your fantasy football draft picks and view team standings
      efficiently.
      <ul>
        <li>
          <strong>Fetch Draft Data:</strong> Enter your Yahoo league ID and
          click "Fetch Draft Data" to get real-time updates on draft picks.
        </li>
        <li>
          <strong>Fetch Standings:</strong> View the current standings of teams
          within your league.
        </li>
        <li>
          <strong>Fetch Teams:</strong> Display team information and rosters.
        </li>
        <li>
          <strong>Fetch Player Details:</strong> Retrieve detailed information
          about players, including stats and ownership.
        </li>
        <li>
          <strong>View Free Agents:</strong> Fetch a list of available free
          agents based on the position selected.
        </li>
      </ul>
    </div>

    <div class="form-inline">
      <input
        type="text"
        id="leagueId"
        class="compact-input"
        placeholder="Enter League ID (e.g., nfl.l.818153)"
      />
      <button id="fetchDraftResults" class="compact-button">
        Fetch Draft Results
      </button>
    </div>

    <div id="draftBoard" class="round-container"></div>

    <!-- New table for displaying draft results -->
    <table id="draftResultsTable" class="draft-results-table" style="display: none;">
      <thead>
        <tr>
          <th>Player Name</th>
          <th>Player ID</th>
          <th>Position Type</th>
          <th>Round</th>
          <th>Pick</th>
          <th>Team</th>
        </tr>
      </thead>
      <tbody id="draftResultsBody"></tbody>
    </table>

    <script>
      let lastFetchedPick = 0;
      const displayedPlayers = new Set();
      const playerDetailsCache = {}; // Cache for player details

      async function fetchPlayerDetails(leagueId, player, retries = 3) {
        try {
          const response = await fetch(
            `/api/player-details?league_id=${leagueId}&player=${player.player_id}`
          );
          const playerData = await response.json();
          return playerData.details[0];
        } catch (error) {
          console.error("Error fetching player details:", error);
          if (retries > 0) {
            console.log(`Retrying... (${retries} attempts left)`);
            await new Promise((resolve) =>
              setTimeout(resolve, 1000 * (4 - retries))
            ); // Exponential backoff
            return fetchPlayerDetails(leagueId, player, retries - 1);
          } else {
            return null;
          }
        }
      }

      async function fetchDraftResults() {
        const leagueId = document.getElementById("leagueId").value;
        if (!leagueId) {
          alert("Please enter a League ID."); // Alert if no League ID is provided
          return;
        }
        try {
          const response = await fetch("/api/drafts/" + leagueId);
          const data = await response.json();
          const draftBoard = document.getElementById("draftBoard");
          const draftResultsBody = document.getElementById("draftResultsBody");
          draftResultsBody.innerHTML = ""; // Clear previous results

          const rounds = {};

          data.forEach((result) => {
            const round = result.round;
            if (!rounds[round]) {
              rounds[round] = [];
            }
            rounds[round].push(result);
          });

          // Collect all player IDs for batch fetching
          const allPlayerIds = data.map(result => result.player_id);
          const playerDetails = await fetchPlayerDetailsBatch(leagueId, allPlayerIds);

          for (const round in rounds) {
            let roundContainer = document.querySelector(
              `.round-container[data-round="${round}"]`
            );
            if (!roundContainer) {
              roundContainer = document.createElement("div");
              roundContainer.className = "round-container";
              roundContainer.setAttribute("data-round", round);

              const roundTitle = document.createElement("div");
              roundTitle.className = "round-title";
              roundTitle.innerText = `Round ${round}`;
              roundContainer.appendChild(roundTitle);

              const playerCards = document.createElement("div");
              playerCards.className = "player-cards";
              roundContainer.appendChild(playerCards);

              draftBoard.appendChild(roundContainer);
            }

            const playerCards = roundContainer.querySelector(".player-cards");

            let pickCount = 1; // Initialize pick count for the round

            for (const player of rounds[round]) {
              const playerInfo = playerDetails[player.player_id];
              if (playerInfo) {
                const playerCard = document.createElement("div");
                playerCard.className = `player-card ${playerInfo.display_position}`;
                playerCard.innerHTML = `
                                  <div class="card-header">
                                      <span>${playerInfo.display_position}</span>
                                      <span>${round}.${pickCount}</span>
                                      <span>${playerInfo.editorial_team_abbr}</span>
                                  </div>
                                  <img src="${playerInfo.image_url}" alt="${playerInfo.name.full}">
                                  <div class="player-info">
                                      <div class="player-name">${playerInfo.name.full}</div>
                                  </div>
                              `;
                playerCards.appendChild(playerCard);
                pickCount++; // Increment pick count for the next player

                // Add row to the draft results table
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${playerInfo.name.full}</td>
                  <td>${player.player_id}</td>
                  <td>${playerInfo.position_type}</td>
                  <td>${round}</td>
                  <td>${pickCount - 1}</td>
                  <td>${playerInfo.editorial_team_abbr}</td>
                `;
                draftResultsBody.appendChild(row);
              }
            }
          }

          // Show the draft results table
          document.getElementById("draftResultsTable").style.display = "table";

          // Update the last fetched pick
          lastFetchedPick = data.length;
        } catch (error) {
          console.error("Error fetching draft results:", error);
        }
      }

      async function checkForNewPicks() {
        const leagueId = document.getElementById("leagueId").value;
        if (!leagueId) {
          return;
        }
        try {
          const response = await fetch("/api/drafts/" + leagueId);
          const data = await response.json();

          if (data.length > lastFetchedPick) {
            // New picks have been made, update the draft board
            await fetchDraftResults();
          }
        } catch (error) {
          console.error("Error checking for new picks:", error);
        }
      }

      // New function to fetch player details in batch with caching
      async function fetchPlayerDetailsBatch(leagueId, playerIds) {
        const uncachedPlayerIds = playerIds.filter(id => !playerDetailsCache[id]);
        if (uncachedPlayerIds.length === 0) {
          // If all player details are cached, return the cached data
          return playerIds.reduce((acc, id) => {
            acc[id] = playerDetailsCache[id];
            return acc;
          }, {});
        }

        try {
          const response = await fetch(`/api/player-details?league_id=${leagueId}&player=${uncachedPlayerIds.join(',')}`);
          const playerData = await response.json();
          playerData.details.forEach(player => {
            playerDetailsCache[player.player_id] = player; // Cache the player details
          });

          // Return all player details, including cached and newly fetched
          return playerIds.reduce((acc, id) => {
            acc[id] = playerDetailsCache[id];
            return acc;
          }, {});
        } catch (error) {
          console.error("Error fetching player details in batch:", error);
          return {};
        }
      }

      document
        .getElementById("fetchDraftResults")
        .addEventListener("click", async () => {
          await fetchDraftResults();
          setInterval(checkForNewPicks, 30000); // Check for new picks every 30 seconds
        });
    </script>
  </body>
</html>
